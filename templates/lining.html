<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lining ‚Äì Auto Scan QR </title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f4f4f6;
      margin: 0;
      padding: 30px;
      color: #333;
    }
    h2 {
      margin-bottom: 12px;
      color: #2c3e50;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR */
    #scanContainer {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    #scanContainer input {
      width: 95%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠ */
    #spoolListContainer {
      background: #ffffff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
      position: relative;
      display: none; /* ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô */
    }
    #spoolListContainer h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #2c3e50;
      font-size: 18px;
    }
    #spoolList {
      list-style: none;
      padding: 0;
    }
    #spoolList li {
      font-size: 16px;
      padding: 8px 12px;
      background-color: #f9fafb;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    /* ‡∏õ‡∏∏‡πà‡∏° Submit */
    #submitBtn {
      position: absolute;
      top: 20px;
      right: 20px;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #30c662;
      color: white;
      cursor: pointer;
    }
    #submitBtn:hover {
      background: #23c83c;
    }
  </style>
</head>
<body>
  
  <h2>üß© Lining ‚Äì Auto Scan QR </h2>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡πÅ‡∏Å‡∏ô QR (‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à) -->
  <div id="scanContainer">
    <label for="cartInput"><strong>üì¶ Scan Cart Barcode:</strong></label><br><br>
    <input type="text" id="cartInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô CART-745 S014 S020 S015" autofocus />
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ã‡πà‡∏≠‡∏ô) -->
  <div id="spoolListContainer">
    <!-- ‡∏õ‡∏∏‡πà‡∏° Submit -->
    <button id="submitBtn" onclick="submitCart()">Submit</button>
    <!-- ‡πÅ‡∏™‡∏î‡∏á Cart ID -->
    <h3 id="cartHeader">üöö Cart ID: </h3>
    <ul id="spoolList"></ul>
  </div>

  <script>
    let debounceTimer = null;
    let currentCartId = "";
    let currentSpools = [];

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô input ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à) ‡πÉ‡∏´‡πâ debounce ‡∏£‡∏≤‡∏ß 300ms
    document.getElementById('cartInput').addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        processScan();
      }, 300);
    });

    /**
     * processScan()
     * ‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å #cartInput ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏¢‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥ ‡∏´‡∏≤‡∏Å‡πÄ‡∏à‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ó‡πà‡∏≠ (Sxxx)
     * ‡∏à‡∏∞‡∏î‡∏∂‡∏á Cart ID ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Spool IDs ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á
     */
    function processScan() {
      const raw = document.getElementById('cartInput').value.trim();
      if (!raw) return;

      // ‡πÅ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏° whitespace
      const parts = raw.split(/\s+/);
      const cartId = parts[0].toUpperCase();
      // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ S ‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡πÄ‡∏ä‡πà‡∏ô S014)
      const spools = parts.slice(1)
                          .filter(p => /^S\d+/i.test(p))
                          .map(p => p.toUpperCase());

      if (spools.length === 0) {
        alert('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ó‡πà‡∏≠ (‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Sxxx) ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡πÅ‡∏Å‡∏ô');
        document.getElementById('cartInput').value = "";
        return;
      }

      // ‡πÄ‡∏Å‡πá‡∏ö Cart ID ‡πÅ‡∏•‡∏∞ Spool IDs ‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô Submit
      currentCartId = cartId;
      currentSpools = spools.slice();

      // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤
      const listContainer = document.getElementById('spoolListContainer');
      const listEl = document.getElementById('spoolList');
      const header = document.getElementById('cartHeader');

      header.textContent = `üöö Cart ID: ${cartId}`;
      listEl.innerHTML = "";
      spools.forEach((s, idx) => {
        const li = document.createElement('li');
        li.textContent = `${idx + 1}. ${s}`;
        listEl.appendChild(li);
      });

      listContainer.style.display = 'block';
      // ‡∏•‡πâ‡∏≤‡∏á input ‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πÅ‡∏Å‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
      document.getElementById('cartInput').value = "";
    }

    /**
     * submitCart()
     * ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î Submit ‡∏à‡∏∞‡∏™‡πà‡∏á payload { spool_ids: [...], status: "finished" }
     * ‡πÑ‡∏õ‡∏ó‡∏µ‡πà endpoint /api/update_status_lining
     */
    async function submitCart() {
      if (!currentCartId || currentSpools.length === 0) {
        alert('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Cart ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ Spool ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏Å‡πà‡∏≠‡∏ô');
        return;
      }

      const payload = {
        spool_ids: currentSpools,
        status: "finished"
      };

      try {
        const response = await fetch('/api/update_status_lining', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const result = await response.json();
        if (result.success) {
          alert(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï status_lining ‡πÄ‡∏õ‡πá‡∏ô 'finished' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${result.updated} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`);
          clearCart();
        } else {
          alert(`‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${result.message || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`);
        }
      } catch (err) {
        console.error(err);
        alert(`‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${err.message}`);
      }
    }

    /**
     * clearCart()
     * ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ currentCartId, currentSpools ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
     */
    function clearCart() {
      const listContainer = document.getElementById('spoolListContainer');
      listContainer.style.display = 'none';
      document.getElementById('spoolList').innerHTML = '';
      document.getElementById('cartHeader').textContent = 'üöö Cart ID: ';
      currentCartId = "";
      currentSpools = [];
    }
  </script>
 
</body>
</html>
